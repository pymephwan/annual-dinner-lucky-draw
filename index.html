<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Annual Dinner Lucky Draw</title>
  <style>
    :root { --bg:#0b0f19; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --line:#243041; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    header {
      padding: 14px 18px; border-bottom: 1px solid var(--line);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    header .title { font-weight: 900; letter-spacing: .5px; }
    header .controls { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    button {
      background: #1f2937; color: var(--text);
      border: 1px solid #374151; border-radius: 10px;
      padding: 10px 12px; cursor:pointer; font-weight: 800;
    }
    button:hover { filter: brightness(1.08); }
    button.danger { border-color:#7f1d1d; background:#3f0d0d; }
    button.primary { border-color:#2563eb; background:#0b1b3f; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    main { padding: 16px; }
    .layout {
      display:grid;
      grid-template-columns: .78fr 1.22fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 1100px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .label { color: var(--muted); font-size: 13px; margin-bottom: 10px; font-weight: 900; letter-spacing: .2px; }
    .hint { color: var(--muted); font-size: 13px; font-weight: 650; }
    select {
      border-radius: 14px;
      border: 1px solid #374151;
      background: #0f172a;
      color: var(--text);
      font-weight: 900;
      outline: none;
    }
    .center {
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center;
    }
    .inputRow { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .drawSelect {
      width: 210px;
      padding: 12px 12px;
      font-size: 18px;
      text-align-last: center;
    }
    .bigNumber {
      font-size: clamp(120px, 18vw, 260px);
      line-height: 1;
      font-weight: 950;
      letter-spacing: 2px;
      margin: 14px 0 10px;
    }
    .hitBox {
      width: min(740px, 96%);
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px 14px;
      background: #0f172a;
      text-align:left;
    }
    .hitList { margin: 0; padding-left: 18px; display:grid; gap: 6px; }
    .historyWrap { width: min(820px, 98%); margin-top: 12px; }
    .history {
      display:flex; flex-wrap:wrap; gap:10px;
      justify-content:center;
      max-height: 220px; overflow:auto;
      padding: 8px 6px 2px;
    }
    .badge {
      background:#0b1220; border:1px solid #334155;
      border-radius: 14px; padding: 10px 14px;
      font-weight: 950;
      font-size: 22px;
      min-width: 56px;
      text-align:center;
    }
    .tableTopRow { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      background:#0f172a; border:1px solid #243041;
      font-weight: 900;
    }
    .smallNote { color: var(--muted); font-size: 12px; margin-top: 6px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--line); text-align:left; vertical-align: top; }
    th { color: var(--muted); font-size: 13px; font-weight: 950; }
    td { font-size: 14px; }
    .count { font-size: 22px; font-weight: 950; }
    .hits { display:flex; flex-wrap:wrap; gap:6px; }
    .hitNum {
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid #334155;
      background:#0f172a;
      font-weight: 950;
    }
    .empName {
      font-size: 18px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .numEdit {
      display:flex; flex-wrap:wrap; gap:6px;
      align-items:center;
    }
    .numEdit select {
      width: 58px;
      padding: 7px 8px;
      font-size: 14px;
      text-align-last: center;
      border-radius: 10px;
      background: #0b1220;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: none !important;
    }
    .numEdit select::-ms-expand { display: none; }
    .rpBadge {
      display:inline-flex;
      align-items:baseline;
      gap:8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #7f1d1d;
      background: #2a0a0a;
      font-weight: 950;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    .rpBadge .n { font-size: 22px; line-height: 1; }
    .rpBadge .t {
      font-size: 12px;
      color: #fca5a5;
      font-weight: 900;
      letter-spacing: .6px;
    }
    .rpZero { color: var(--muted); font-weight: 900; }
    /* ===== Prize Wheel Modal ===== */
    .modalBack{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.70);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 9999;
      overflow: auto;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(1400px, 98vw);
      max-height: 94vh;
      margin: 2vh 0;
      background: #0d1322;
      border: 1px solid #2a3a56;
      border-radius: 18px;
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      overflow: visible;
      position: relative;
      padding: 16px;
    }
    .closeX{
      position: absolute;
      top: 10px; right: 10px;
      width: 44px; height: 44px;
      border-radius: 12px;
      border: 1px solid #374151;
      background: #0b1220;
      color: var(--text);
      font-weight: 950;
      cursor: pointer;
    }
    .closeX:hover{ filter: brightness(1.08); }
    .wheelOnlyWrap{
      display:flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 18px;
      padding: 10px 8px;
    }
    @media (max-width: 980px){
      .wheelOnlyWrap{ flex-direction: column; }
    }
    .wheelStage{
      position: relative;
      width: min(760px, 72vmin);
      aspect-ratio: 1/1;
      display:flex; align-items:center; justify-content:center;
      flex: 0 0 auto;
    }
    canvas#wheelCanvas{
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 1px solid #2a3a56;
      background: #0b1220;
      display:block;
    }
    .pointer{
      position:absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 32px solid #e5e7eb;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.55));
      z-index: 2;
    }
    .topName{
      position:absolute;
      top: -78px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 16px;
      border-radius: 14px;
      border: 1px solid #2a3a56;
      background: rgba(15, 23, 42, 0.92);
      font-weight: 950;
      font-size: clamp(26px, 3.6vw, 56px);
      letter-spacing: .2px;
      max-width: 94%;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      z-index: 3;
    }
    .spinSide{
      display:flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      justify-content: center;
      min-width: 220px;
    }
    .spinBtn{
      padding: 16px 18px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .4px;
      min-width: 220px;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">üé± Annual Dinner Lucky Draw</div>
    <div class="controls">
      <button class="primary" id="btnWheel">Prize Wheel</button>
      <button id="btnFullscreen">Fullscreen</button>
      <button id="btnUndo">Undo Last</button>
      <button class="danger" id="btnReset">Reset All</button>
    </div>
  </header>
  <main>
    <div class="layout">
      <!-- LEFT: Draw -->
      <section class="card center">
        <div class="label">Select a drawn number</div>
        <div class="inputRow">
          <select id="selectDraw" class="drawSelect"></select>
          <button id="btnAdd">Add</button>
          <span class="hint">(Dropdown: 1‚Äì60)</span>
        </div>
        <div style="height:12px"></div>
        <div class="label">Latest drawn number</div>
        <div class="bigNumber" id="lastNumber">‚Äî</div>
        <div class="hitBox">
          <div class="label" style="margin-bottom:8px;">*** Winners in this round ***</div>
          <ul class="hitList" id="hitList">
            <li class="hint">No number drawn yet</li>
          </ul>
        </div>
        <div class="historyWrap">
          <div class="label" style="margin-top:14px;">Draw history (in order)</div>
          <div class="history" id="history"></div>
        </div>
      </section>
      <!-- RIGHT: Table -->
      <section class="card">
        <div class="tableTopRow">
          <div>
            <div class="label" style="margin-bottom:6px;">Cumulative results</div>
            <div class="pill">Drawn: <span id="drawnCount">0</span></div>
          </div>
          <div class="controls" style="gap:10px;">
            <button id="btnToggleAll">Show All (incl. no hits)</button>
          </div>
        </div>
        <div class="smallNote">
          Rule (based on total hits, NOT cumulative): 1‚Üí1 ÔΩú 2‚Üí2 ÔΩú 3‚Üí3 ÔΩú 4‚Üí5 ÔΩú 5‚Üí10 ÔΩú 6‚Üí20
        </div>
        <div style="overflow:auto; margin-top: 10px;">
          <table>
            <thead>
              <tr>
                <th style="width:48px;">#</th>
                <th style="min-width:170px;">Name</th>
                <th style="width:90px;">Hits</th>
                <th style="width:160px;">Red Packets</th>
                <th style="min-width:220px;">Hit numbers</th>
                <th style="min-width:320px;">Chosen numbers</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>
  <!-- Prize Wheel Modal -->
  <div class="modalBack" id="wheelModalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="closeX" id="btnWheelClose" aria-label="Close">‚úï</button>
      <div class="wheelOnlyWrap">
        <div class="wheelStage">
          <div class="topName" id="topName">‚Äî</div>
          <div class="pointer"></div>
          <canvas id="wheelCanvas" width="1600" height="1600"></canvas>
        </div>
        <div class="spinSide">
          <button class="primary spinBtn" id="btnSpin">START SPIN</button>
        </div>
      </div>
    </div>
  </div>

<script>
/** ====== EMPLOYEES ====== */
const EMPLOYEES = [
  { name: "Fai", nums: [1, 2, 3, 4, 5, 6] },
  { name: "Lily", nums: [11, 12, 13, 14, 15, 16] },
  { name: "Faye Faye", nums: [21, 22, 23, 24, 25, 26] },
  { name: "ÊØÖÊØÖ", nums: [31, 32, 33, 34, 35, 36] },
  { name: "Loren", nums: [3, 11, 17, 25, 35, 46] },
  { name: "Minhee", nums: [7, 8, 9, 10, 11, 12] },
  { name: "Jenna", nums: [17, 18, 19, 20, 21, 22] },
  { name: "Jacky", nums: [44, 45, 46, 47, 48, 49] },
  { name: "Magic", nums: [8, 16, 24, 32, 40, 48] },
  { name: "Candy", nums: [1, 10, 14, 22, 26, 33] },
  { name: "Ê±ü‰ªî(Kong)", nums: [1, 2, 3, 4, 5, 6] },
  { name: "Allen", nums: [3, 9, 11, 15, 19, 23] },
  { name: "Winner", nums: [1, 10, 11, 12, 26, 31] },
  { name: "Â®úÂßê(Na)", nums: [8, 16, 17, 18, 36, 44] },
  { name: "Tony(WH)", nums: [1, 5, 8, 10, 12, 16] },
  { name: "È∫óÂßê(Lai)", nums: [7, 13, 16, 26, 28, 36] },
  { name: "Percy", nums: [44, 45, 46, 47, 48, 49] },
  { name: "Lun", nums: [6, 8, 21, 24, 30, 35] },
  { name: "Cherry", nums: [2, 3, 7, 10, 12, 24] },
  { name: "Yui", nums: [7, 16, 26, 29, 43, 49] },
  { name: "Annie", nums: [1, 12, 23, 24, 25, 28] },
  { name: "Paul", nums: [9, 14, 16, 25, 26, 35] },
  { name: "Tony(Sales)", nums: [16, 20, 28, 38, 42, 44] },
  { name: "Mephy", nums: [10, 11, 12, 13, 14, 49] },
  { name: "Sin", nums: [1, 3, 6, 8, 13, 18] },
  { name: "Lydia", nums: [2, 7, 11, 28, 30, 32] },
  { name: "Andy", nums: [8, 12, 26, 33, 35, 43] },
  { name: "ËâØ(Leung)", nums: [6, 18, 32, 33, 46, 48] },
  { name: "Eva", nums: [6, 11, 13, 18, 22, 40] },
  { name: "Grace", nums: [11, 18, 21, 45, 47, 49] },
  { name: "Ico", nums: [3, 7, 10, 21, 26, 32] },
  { name: "Jerry", nums: [9, 15, 17, 23, 36, 48] },
  { name: "ÈòøÊ∫ê(Yuen)", nums: [13, 14, 28, 33, 40, 44] },
  { name: "ÈòøËªí(Hin)", nums: [7, 14, 21, 28, 35, 49] },
  { name: "ÈòøÁÜπ(Hei)", nums: [1, 7, 8, 10, 11, 18] },
  { name: "ÈòøÂäõ(Lik)", nums: [6, 7, 28, 30, 38, 40] },
  { name: "Â®£Âßê(Tai)", nums: [1, 7, 11, 13, 14, 16] },
  { name: "Êù±Âì•(Tung Gor)", nums: [4, 11, 16, 24, 45, 48] },
  { name: "Ëà™Âì•(Hong Gor)", nums: [2, 18, 19, 26, 40, 48] },
  { name: "Keith", nums: [2, 4, 6, 7, 24, 47] },
  { name: "Flora", nums: [7, 14, 23, 28, 35, 42] },
  { name: "Ryan", nums: [6, 8, 12, 21, 30, 33] },
  { name: "Phoebe", nums: [5, 18, 26, 33, 38, 42] },
  { name: "Steve", nums: [8, 16, 24, 32, 40, 48] },
  { name: "Jesse", nums: [1, 2, 6, 11, 17, 49] },
  { name: "Jeffery Yip", nums: [5, 6, 12, 26, 35, 42] },
  { name: "Sean", nums: [5, 8, 9, 19, 23, 45] },
  { name: "Minto", nums: [7, 9, 24, 27, 35, 36] },
  { name: "Tim", nums: [8, 14, 21, 33, 41, 47] },
  { name: "Joseph", nums: [7, 9, 16, 22, 28, 45] },
  { name: "Joyce", nums: [2, 4, 7, 18, 24, 36] },
  { name: "Yeonu", nums: [3, 9, 14, 22, 31, 43] },
  { name: "Shania", nums: [2, 17, 24, 31, 39, 48] },
  { name: "Shin", nums: [5, 7, 18, 21, 28, 33] },
  { name: "Han", nums: [7, 11, 13, 22, 35, 41] },
  { name: "Chul(Everlabs)", nums: [27, 28, 29, 30, 31, 32] },
  { name: "Kim(Everlabs)", nums: [37, 38, 39, 40, 41, 42] },
  { name: "Louis", nums: [1, 6, 11, 16, 24, 27] },
  { name: "Joy", nums: [7, 9, 15, 28, 37, 41] },
  { name: "Kico", nums: [7, 11, 12, 27, 35, 46] },
];
const MAX_NUM = 60;
const CHOSEN_SLOTS = 6;
const state = {
  drawn: [],
  showAll: false,
  people: EMPLOYEES.map(p => ({
    name: p.name,
    nums: expandToSlots(p.nums),
    hitSet: new Set(),
  })),
};

/* ===== DOM (main page) ===== */
const elLast = document.getElementById("lastNumber");
const elHitList = document.getElementById("hitList");
const elHistory = document.getElementById("history");
const elTbody = document.getElementById("tbody");
const elDrawnCount = document.getElementById("drawnCount");
const elToggleAll = document.getElementById("btnToggleAll");
const elSelectDraw = document.getElementById("selectDraw");
document.getElementById("btnAdd").addEventListener("click", addDrawFromSelect);
document.getElementById("btnUndo").addEventListener("click", undoLast);
document.getElementById("btnReset").addEventListener("click", resetAll);
document.getElementById("btnFullscreen").addEventListener("click", () => {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
});
elToggleAll.addEventListener("click", () => {
  state.showAll = !state.showAll;
  elToggleAll.textContent = state.showAll ? "Show winners only" : "Show All (incl. no hits)";
  renderTable();
});

/* ===== Helpers (main) ===== */
function expandToSlots(nums) {
  const out = Array(CHOSEN_SLOTS).fill(null);
  for (let i = 0; i < Math.min(nums.length, CHOSEN_SLOTS); i++) out[i] = nums[i];
  return out;
}
function isValidNum(n) { return Number.isFinite(n) && n >= 1 && n <= MAX_NUM; }
function getActiveNums(person) { return person.nums.filter(isValidNum); }
function buildOptions() {
  const frag = document.createDocumentFragment();
  for (let i = 1; i <= MAX_NUM; i++) {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    frag.appendChild(opt);
  }
  return frag;
}
function initDrawSelect() {
  elSelectDraw.innerHTML = "";
  elSelectDraw.appendChild(buildOptions());
  elSelectDraw.value = "1";
}
function redPacketsForHitCount(hitCount) {
  switch (hitCount) {
    case 1: return 1;
    case 2: return 2;
    case 3: return 3;
    case 4: return 5;
    case 5: return 10;
    case 6: return 20;
    default: return 0;
  }
}

/* ===== Main draw flow ===== */
function addDrawFromSelect() {
  const n = Number(elSelectDraw.value);
  if (!isValidNum(n)) return;
  addDraw(n);
}
function addDraw(n) {
  state.drawn.push(n);
  elLast.textContent = String(n);
  const hitNames = [];
  for (const person of state.people) {
    if (getActiveNums(person).includes(n)) {
      person.hitSet.add(n);
      hitNames.push(person.name);
    }
  }
  renderHitList(hitNames, n);
  renderHistory();
  renderTable();
  elDrawnCount.textContent = state.drawn.length;
}
function renderHitList(hitNames, n) {
  elHitList.innerHTML = "";
  if (!state.drawn.length) {
    elHitList.innerHTML = `<li class="hint">No number drawn yet</li>`;
    return;
  }
  if (hitNames.length === 0) {
    const li = document.createElement("li");
    li.className = "hint";
    li.textContent = `No winner for (${n})`;
    elHitList.appendChild(li);
    return;
  }
  hitNames.sort((a,b)=>a.localeCompare(b, "en"));
  for (const name of hitNames) {
    const li = document.createElement("li");
    li.innerHTML = `<span style="font-weight:950;">${escapeHtml(name)}</span>`;
    elHitList.appendChild(li);
  }
}
function renderHistory() {
  elHistory.innerHTML = "";
  for (let i = 0; i < state.drawn.length; i++) {
    const b = document.createElement("span");
    b.className = "badge";
    b.textContent = state.drawn[i];
    elHistory.appendChild(b);
  }
}
function renderTable() {
  const rows = state.people
    .map(p => {
      const hitCount = p.hitSet.size;
      return {
        name: p.name,
        hitCount,
        packets: redPacketsForHitCount(hitCount),
        hits: Array.from(p.hitSet).sort((a,b)=>a-b),
      };
    })
    .filter(r => state.showAll ? true : r.hitCount > 0)
    .sort((a,b) => {
      if (b.packets !== a.packets) return b.packets - a.packets;
      if (b.hitCount !== a.hitCount) return b.hitCount - a.hitCount;
      return a.name.localeCompare(b.name, "en");
    });
  elTbody.innerHTML = "";
  rows.forEach((r, idx) => {
    const tr = document.createElement("tr");
    const tdRank = document.createElement("td");
    tdRank.textContent = String(idx + 1);
    const tdName = document.createElement("td");
    tdName.innerHTML = `<span class="empName">${escapeHtml(r.name)}</span>`;
    const tdCount = document.createElement("td");
    tdCount.innerHTML = `<span class="count">${r.hitCount}</span>`;
    const tdPackets = document.createElement("td");
    if (r.packets <= 0) {
      tdPackets.innerHTML = `<span class="rpZero">‚Äî</span>`;
    } else {
      tdPackets.innerHTML = `
        <span class="rpBadge">
          <span class="n">${r.packets}</span>
          <span class="t">pcs</span>
        </span>
      `;
    }
    const tdHits = document.createElement("td");
    const hitsWrap = document.createElement("div");
    hitsWrap.className = "hits";
    if (r.hits.length === 0) {
      const s = document.createElement("span");
      s.className = "hint";
      s.textContent = "‚Äî";
      hitsWrap.appendChild(s);
    } else {
      r.hits.forEach(n => {
        const span = document.createElement("span");
        span.className = "hitNum";
        span.textContent = n;
        hitsWrap.appendChild(span);
      });
    }
    tdHits.appendChild(hitsWrap);
    const tdNums = document.createElement("td");
    const wrap = document.createElement("div");
    wrap.className = "numEdit";
    const person = state.people.find(p => p.name === r.name);
    for (let i = 0; i < CHOSEN_SLOTS; i++) {
      const sel = document.createElement("select");
      sel.appendChild(buildOptions());
      const cur = person.nums[i];
      sel.value = isValidNum(cur) ? String(cur) : "1";
      sel.addEventListener("change", () => {
        const v = Number(sel.value);
        person.nums[i] = isValidNum(v) ? v : person.nums[i];
        recomputeAllHits();
      });
      wrap.appendChild(sel);
    }
    tdNums.appendChild(wrap);
    tr.appendChild(tdRank);
    tr.appendChild(tdName);
    tr.appendChild(tdCount);
    tr.appendChild(tdPackets);
    tr.appendChild(tdHits);
    tr.appendChild(tdNums);
    elTbody.appendChild(tr);
  });
}
function recomputeAllHits() {
  for (const p of state.people) p.hitSet = new Set();
  for (const n of state.drawn) {
    for (const p of state.people) {
      if (getActiveNums(p).includes(n)) p.hitSet.add(n);
    }
  }
  if (state.drawn.length) {
    const last = state.drawn[state.drawn.length - 1];
    const hitNames = [];
    for (const p of state.people) {
      if (getActiveNums(p).includes(last)) hitNames.push(p.name);
    }
    renderHitList(hitNames, last);
    elLast.textContent = String(last);
  } else {
    elLast.textContent = "‚Äî";
    elHitList.innerHTML = `<li class="hint">No number drawn yet</li>`;
  }
  renderHistory();
  renderTable();
  elDrawnCount.textContent = state.drawn.length;
}
function undoLast() {
  if (state.drawn.length === 0) return;
  state.drawn.pop();
  recomputeAllHits();
}
function resetAll() {
  const ok = confirm("Are you sure you want to reset everything? (This will clear all draw history)");
  if (!ok) return;
  state.drawn = [];
  state.people = EMPLOYEES.map(p => ({
    name: p.name,
    nums: expandToSlots(p.nums),
    hitSet: new Set(),
  }));
  state.showAll = false;
  elToggleAll.textContent = "Show All (incl. no hits)";
  elLast.textContent = "‚Äî";
  elHitList.innerHTML = `<li class="hint">No number drawn yet</li>`;
  renderHistory();
  renderTable();
  elDrawnCount.textContent = "0";
}
function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================================================
   Prize Wheel (LONG STOP + RANDOM ORDER EVERY TIME)
========================================================= */
const wheelModalBack = document.getElementById("wheelModalBack");
const btnWheel = document.getElementById("btnWheel");
const btnWheelClose = document.getElementById("btnWheelClose");
const btnSpin = document.getElementById("btnSpin");
const wheelCanvas = document.getElementById("wheelCanvas");
const elTopName = document.getElementById("topName");
const wctx = wheelCanvas.getContext("2d");
const wheelState = {
  namesPool: [],
  angle: 0,
  mode: "idle",
  omega: 0,
  omegaTarget: 0,
  lastTs: 0,
  stopStartAngle: 0,
  stopTargetAngle: 0,
  stopStartTime: 0,
  stopDurationMs: 0,
};
let wheelStaticCanvas = null;
let wheelStaticCtx = null;
let wheelStaticDirty = true;

function buildWheelNamesFromEmployees() {
  const seen = new Set();
  const out = [];
  for (const p of EMPLOYEES) {
    const nm = String(p.name ?? "").trim();
    if (!nm) continue;

    if (
      nm === "Kico" ||
      nm === "Faye Faye" ||
      nm === "ÊØÖÊØÖ" ||
      nm === "Jenna" ||
      nm === "Yeonu" ||
      nm === "Chul(Everlabs)" ||
      nm === "Kim(Everlabs)"
    ) {
      continue;
    }

    if (seen.has(nm)) continue;
    seen.add(nm);
    out.push(nm);
  }
  return out;
}

function getWinnerIndexAtAngle(angle, N) {
  const pointerAngle = -Math.PI/2;
  let a = pointerAngle - angle;
  a = ((a % (Math.PI*2)) + (Math.PI*2)) % (Math.PI*2);
  const slice = (Math.PI*2)/N;
  return Math.floor(a / slice);
}

function updateTopName() {
  const names = wheelState.namesPool;
  if (!names.length) { elTopName.textContent = "‚Äî"; return; }
  const idx = getWinnerIndexAtAngle(wheelState.angle, names.length);
  elTopName.textContent = names[idx] ?? "‚Äî";
}

function easeOutQuart(t) {
  return 1 - Math.pow(1 - t, 4);
}

function renderWheelStatic() {
  const names = wheelState.namesPool;
  const N = names.length;
  if (!wheelStaticCanvas) {
    wheelStaticCanvas = document.createElement("canvas");
    wheelStaticCanvas.width = wheelCanvas.width;
    wheelStaticCanvas.height = wheelCanvas.height;
    wheelStaticCtx = wheelStaticCanvas.getContext("2d");
  }
  const ctx = wheelStaticCtx;
  const cw = wheelStaticCanvas.width;
  const ch = wheelStaticCanvas.height;
  const cx = cw / 2, cy = ch / 2;
  const R = Math.min(cx, cy) * 0.955;
  const capR = R * 0.14;
  ctx.clearRect(0, 0, cw, ch);
  ctx.save();
  ctx.translate(cx, cy);
  ctx.beginPath();
  ctx.arc(0, 0, R, 0, Math.PI * 2);
  ctx.fillStyle = "#0b1220";
  ctx.fill();
  ctx.lineWidth = 10;
  ctx.strokeStyle = "#2a3a56";
  ctx.stroke();
  if (N === 0) {
    ctx.fillStyle = "#9ca3af";
    ctx.font = "950 72px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("No names", 0, 0);
    ctx.restore();
    wheelStaticDirty = false;
    return;
  }
  ctx.save();
  ctx.beginPath();
  ctx.arc(0, 0, R * 0.965, 0, Math.PI * 2);
  ctx.clip();
  const slice = (Math.PI * 2) / N;
  for (let i = 0; i < N; i++) {
    const start = i * slice;
    const end = start + slice;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, R, start, end);
    ctx.closePath();
    ctx.fillStyle = (i % 2 === 0) ? "#0f172a" : "#111827";
    ctx.fill();
    ctx.strokeStyle = "#243041";
    ctx.lineWidth = 2.5;
    ctx.stroke();
    ctx.save();
    const mid = (start + end) / 2;
    ctx.rotate(mid);
    const rAnchor = R * 0.955;
    ctx.translate(rAnchor, 0);
    const flip = (mid > Math.PI/2 && mid < Math.PI*1.5);
    if (flip) ctx.rotate(Math.PI);
    ctx.textAlign = flip ? "left" : "right";
    ctx.textBaseline = "middle";
    const baseFs = 92;
    const fs = Math.max(34, baseFs - N * 0.55);
    ctx.font = `950 ${fs}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    const txt = names[i] ?? "";
    const margin = R * 0.03;
    const maxOneThird = R * 0.34;
    const maxSafe = rAnchor - capR - margin;
    const inwardSpace = Math.max(0, Math.min(maxOneThird, maxSafe));
    const m = ctx.measureText(txt);
    let sx = 1;
    if (m.width > inwardSpace && inwardSpace > 0) sx = inwardSpace / m.width;
    ctx.scale(sx, 1);
    ctx.shadowColor = "rgba(0,0,0,0.55)";
    ctx.shadowBlur = 10;
    ctx.lineWidth = 14;
    ctx.strokeStyle = "rgba(0,0,0,0.85)";
    ctx.strokeText(txt, 0, 0);
    ctx.fillStyle = "#e5e7eb";
    ctx.fillText(txt, 0, 0);
    ctx.restore();
  }
  ctx.restore();
  ctx.beginPath();
  ctx.arc(0, 0, capR, 0, Math.PI * 2);
  ctx.fillStyle = "#0b1220";
  ctx.fill();
  ctx.strokeStyle = "#2a3a56";
  ctx.lineWidth = 6;
  ctx.stroke();
  ctx.restore();
  wheelStaticDirty = false;
}

function drawWheel() {
  if (wheelStaticDirty) renderWheelStatic();
  const cw = wheelCanvas.width;
  const ch = wheelCanvas.height;
  const cx = cw/2, cy = ch/2;
  wctx.clearRect(0, 0, cw, ch);
  wctx.save();
  wctx.translate(cx, cy);
  wctx.rotate(wheelState.angle);
  wctx.drawImage(wheelStaticCanvas, -cx, -cy);
  wctx.restore();
  updateTopName();
}

/* ===== Continuous spin ===== */
function startSpinForever() {
  if (!wheelState.namesPool.length) return;
  if (wheelState.mode !== "idle") return;
  wheelState.mode = "free";
  btnSpin.textContent = "END SPIN";
  btnSpin.disabled = false;
  const rps = 2.8 + Math.random() * 1.0;
  wheelState.omegaTarget = (Math.PI * 2 * rps) / 1000;
  wheelState.omega = wheelState.omegaTarget * 0.25;
  wheelState.lastTs = performance.now();
  requestAnimationFrame(tickFreeSpin);
}

function tickFreeSpin(ts) {
  if (wheelState.mode !== "free") return;
  const dt = Math.min(40, Math.max(0, ts - wheelState.lastTs));
  wheelState.lastTs = ts;
  const k = 0.08;
  wheelState.omega += (wheelState.omegaTarget - wheelState.omega) * k;
  wheelState.angle += wheelState.omega * dt;
  wheelState.angle = wheelState.angle % (Math.PI * 2);
  drawWheel();
  requestAnimationFrame(tickFreeSpin);
}

/* ===== Long smooth slow stop ===== */
function endSpinAndStop() {
  if (wheelState.mode !== "free") return;
  const names = wheelState.namesPool;
  const N = names.length;
  if (!N) return;
  wheelState.mode = "stopping";
  btnSpin.disabled = true;

  const slice = (Math.PI * 2) / N;
  const winnerIdx = Math.floor(Math.random() * N);
  const pointerAngle = -Math.PI / 2;
  const offset = (Math.random() * 0.8 + 0.1) * slice;
  let baseTarget = pointerAngle - (winnerIdx * slice + offset);

  const extraSpins = 5 + Math.floor(Math.random() * 4); // 5~8Âúà
  const twoPi = Math.PI * 2;
  const spinsNeeded = Math.ceil((wheelState.angle - baseTarget + extraSpins * twoPi) / twoPi);
  const finalTarget = baseTarget + spinsNeeded * twoPi;

  wheelState.stopStartAngle = wheelState.angle;
  wheelState.stopTargetAngle = finalTarget;
  wheelState.stopStartTime = performance.now();

  // ‰Ω†ÊúÄÂæåË®≠ÂÆöÁöÑÂÅúÊ≠¢ÊôÇÈñìÔºö20 ~ 30 Áßí
  wheelState.stopDurationMs = 20000 + Math.random() * 10000;

  requestAnimationFrame(tickStopSpin);
}

function tickStopSpin(ts) {
  if (wheelState.mode !== "stopping") return;
  const elapsed = ts - wheelState.stopStartTime;
  let t = elapsed / wheelState.stopDurationMs;
  t = Math.min(1, Math.max(0, t));

  const eased = easeOutQuart(t);
  wheelState.angle = wheelState.stopStartAngle +
                     (wheelState.stopTargetAngle - wheelState.stopStartAngle) * eased;

  drawWheel();

  if (t < 1) {
    requestAnimationFrame(tickStopSpin);
  } else {
    wheelState.angle = wheelState.stopTargetAngle % (Math.PI * 2);
    drawWheel();
    wheelState.mode = "idle";
    btnSpin.disabled = false;
    btnSpin.textContent = "START SPIN";
  }
}

/* ===== Button & Modal ===== */
btnSpin.addEventListener("click", () => {
  if (wheelState.mode === "idle") startSpinForever();
  else if (wheelState.mode === "free") endSpinAndStop();
});

btnWheel.addEventListener("click", () => {
  wheelModalBack.classList.add("show");

  // ÊØèÊ¨°ÈñãÂïü modal ÈÉΩÈáçÊñ∞Èö®Ê©üÊéíÂàóÂêçÂ≠ó
  const names = buildWheelNamesFromEmployees();

  // Fisher-Yates shuffle
  for (let i = names.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [names[i], names[j]] = [names[j], names[i]];
  }

  wheelState.namesPool = names;
  wheelState.angle = 0;
  wheelState.mode = "idle";
  wheelState.omega = 0;
  wheelState.omegaTarget = 0;
  wheelState.lastTs = 0;
  wheelStaticDirty = true;

  drawWheel();
});

btnWheelClose.addEventListener("click", () => {
  wheelModalBack.classList.remove("show");
});

wheelModalBack.addEventListener("click", (e) => {
  if (e.target === wheelModalBack) wheelModalBack.classList.remove("show");
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && wheelModalBack.classList.contains("show")) {
    wheelModalBack.classList.remove("show");
  }
});

/* ===== Init ===== */
initDrawSelect();
renderHistory();
renderTable();
</script>
</body>
</html>



